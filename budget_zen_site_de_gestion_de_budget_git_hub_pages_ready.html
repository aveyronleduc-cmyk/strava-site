<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BudgetZen ‚Äî Gestion de budget & abonnements</title>
  <meta name="description" content="Site statique pour g√©rer son budget, importer ses transactions, d√©tecter les abonnements et obtenir des conseils d'√©conomies. Donn√©es stock√©es localement (localStorage)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cpath fill='%23fff' d='M0 0h256v256H0z'/%3E%3Cpath d='M128 20c-59.55 0-108 48.45-108 108s48.45 108 108 108 108-48.45 108-108S187.55 20 128 20Zm0 24a84 84 0 1 1 0 168a84 84 0 0 1 0-168Zm-8 28a12 12 0 0 0-12 12v16H84a12 12 0 0 0 0 24h24v16H92a12 12 0 0 0 0 24h16v24a12 12 0 0 0 24 0v-24h16a12 12 0 0 0 0-24h-16v-16h24a12 12 0 0 0 0-24h-24V84a12 12 0 0 0-12-12Z' fill='%231a1a1a'/%3E%3C/svg%3E"/>
  <!-- Tailwind Play CDN (simple, fine for GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-ZsCwQG1yO9TIdxH2NoV1x+8JIfw2iRYx4WJ1PCwqF/4=" crossorigin="anonymous"></script>
  <style>
    /* Smooth scroll & focus */
    html { scroll-behavior: smooth; }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.65); }
    .dark .glass { background: rgba(24,24,27,0.5); }
    .card { @apply rounded-2xl shadow-lg p-5 bg-white dark:bg-zinc-900; }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 font-medium shadow; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-secondary { @apply bg-zinc-200 text-zinc-900 hover:bg-zinc-300 dark:bg-zinc-800 dark:text-zinc-100 dark:hover:bg-zinc-700; }
    .tag { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-zinc-100 text-zinc-700 dark:bg-zinc-800 dark:text-zinc-200; }
    .input { @apply w-full rounded-xl border border-zinc-300 dark:border-zinc-700 bg-white dark:bg-zinc-900 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500; }
    .table { @apply w-full text-sm; }
    .table th { @apply text-left font-semibold text-zinc-700 dark:text-zinc-200; }
    .table td { @apply py-2; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-emerald-50 dark:from-zinc-950 dark:to-zinc-900 text-zinc-900 dark:text-zinc-100">
  <header class="sticky top-0 z-40 border-b border-zinc-200 dark:border-zinc-800 bg-white/80 dark:bg-zinc-950/80 glass">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-indigo-600 grid place-items-center text-white font-bold">Bz</div>
          <h1 class="text-lg sm:text-xl font-semibold">BudgetZen</h1>
          <span id="version" class="tag">v1.0</span>
          <span class="hidden sm:inline tag" title="Donn√©es stock√©es localement">Local-first</span>
        </div>
        <nav class="hidden md:flex items-center gap-1">
          <a href="#dashboard" class="btn btn-secondary">Tableau de bord</a>
          <a href="#transactions" class="btn btn-secondary">Transactions</a>
          <a href="#budgets" class="btn btn-secondary">Budgets</a>
          <a href="#subscriptions" class="btn btn-secondary">Abonnements</a>
          <a href="#rules" class="btn btn-secondary">R√®gles</a>
          <a href="#goals" class="btn btn-secondary">Objectifs</a>
          <a href="#settings" class="btn btn-secondary">Param√®tres</a>
        </nav>
        <div class="flex items-center gap-2">
          <button id="darkToggle" class="btn btn-secondary" title="Mode sombre clair">üåô</button>
          <button id="exportBtn" class="btn btn-primary">Exporter</button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 space-y-10">
    <!-- Hero / Connect bank -->
    <section id="connect" class="card">
      <div class="flex flex-col lg:flex-row gap-6 items-start">
        <div class="flex-1 space-y-4">
          <h2 class="text-2xl font-semibold">Connecter ma banque (GitHub Pages compatible)</h2>
          <p class="text-zinc-600 dark:text-zinc-300">
            Sur GitHub Pages (site statique), la connexion bancaire PSD2 temps r√©el n'est pas possible sans serveur s√©curis√©.
            <strong>BudgetZen</strong> fonctionne <em>localement</em> et propose 3 options :
          </p>
          <ol class="list-decimal pl-6 space-y-2 text-zinc-700 dark:text-zinc-200">
            <li><strong>Importer un fichier</strong> de votre banque (<code>CSV</code>, <code>OFX</code> ou <code>QIF</code>). Votre banque permet souvent l'export des op√©rations.</li>
            <li>Utiliser le <strong>mode D√©mo</strong> pour tester avec de vraies fausses donn√©es.</li>
            <li>Mettre en place plus tard une <strong>passerelle Open Banking</strong> (ex: Nordigen/GoCardless, Bridge, Budget Insight) via un petit serveur proxy.
              Un guide est fourni dans Param√®tres ‚ñ∂Ô∏è "Connexion bancaire avanc√©e".</li>
          </ol>
          <div class="flex gap-3 pt-2">
            <label class="btn btn-secondary cursor-pointer">
              <input id="fileInput" type="file" accept=".csv,.ofx,.qif,.txt" class="hidden" />
              üì• Importer un relev√©
            </label>
            <button id="templateBtn" class="btn btn-secondary">üß© T√©l√©charger mod√®le CSV</button>
            <button id="demoBtn" class="btn btn-primary">‚ö° Remplir avec donn√©es D√©mo</button>
          </div>
          <p class="text-xs text-zinc-500">Les donn√©es restent dans votre navigateur (localStorage). Option de chiffrement disponible dans Param√®tres.</p>
        </div>
        <div class="w-full lg:w-[420px] grid grid-cols-2 gap-3">
          <div class="card">
            <div class="text-sm text-zinc-500">Solde net (mois en cours)</div>
            <div id="kpiNet" class="mt-1 text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-zinc-500">D√©penses (mois)</div>
            <div id="kpiOut" class="mt-1 text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-zinc-500">Revenus (mois)</div>
            <div id="kpiIn" class="mt-1 text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-zinc-500">Abonnements d√©tect√©s</div>
            <div id="kpiSubs" class="mt-1 text-2xl font-semibold">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="card">
      <div class="flex flex-col lg:flex-row gap-8">
        <div class="flex-1">
          <h3 class="text-xl font-semibold mb-3">Flux de tr√©sorerie (12 mois)</h3>
          <canvas id="cashflowChart" height="140"></canvas>
        </div>
        <div class="w-full lg:w-[420px]">
          <h3 class="text-xl font-semibold mb-3">Conseils d'√©conomies (IA l√©g√®re)</h3>
          <ul id="tipsList" class="space-y-3 text-sm"></ul>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="transactions" class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Transactions</h3>
        <div class="flex gap-2">
          <input id="searchInput" class="input w-56" placeholder="Rechercher (texte/cat√©gorie)" />
          <select id="monthFilter" class="input w-40"></select>
          <button id="addTxBtn" class="btn btn-primary">‚ûï Ajouter</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th><th>Libell√©</th><th class="text-right">Montant</th><th>Cat√©gorie</th><th>Compte</th><th></th>
            </tr>
          </thead>
          <tbody id="txTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Budgets -->
    <section id="budgets" class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Budgets mensuels par cat√©gorie</h3>
        <button id="addBudgetBtn" class="btn btn-primary">‚ûï Ajouter un budget</button>
      </div>
      <div id="budgetsList" class="space-y-4"></div>
    </section>

    <!-- Subscriptions -->
    <section id="subscriptions" class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Abonnements d√©tect√©s</h3>
        <button id="refreshSubsBtn" class="btn btn-secondary">üîÅ Recalculer</button>
      </div>
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Marchand</th><th class="text-right">Moyenne ‚Ç¨/mois</th><th>Dernier pr√©l√®vement</th><th>Fr√©quence</th><th>Conseil</th><th></th>
            </tr>
          </thead>
          <tbody id="subsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Rules -->
    <section id="rules" class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">R√®gles d'auto-cat√©gorisation</h3>
        <button id="addRuleBtn" class="btn btn-primary">‚ûï Nouvelle r√®gle</button>
      </div>
      <div class="overflow-x-auto">
        <table class="table">
          <thead><tr><th>Mot-cl√© / Regex</th><th>Cat√©gorie</th><th></th></tr></thead>
          <tbody id="rulesTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Goals -->
    <section id="goals" class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Objectifs & enveloppes</h3>
        <button id="addGoalBtn" class="btn btn-primary">‚ûï Nouvel objectif</button>
      </div>
      <div id="goalsList" class="space-y-4"></div>
    </section>

    <!-- Settings -->
    <section id="settings" class="card">
      <h3 class="text-xl font-semibold mb-4">Param√®tres & Aide</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Devise</label>
            <select id="currencySelect" class="input w-40">
              <option value="EUR">‚Ç¨ (EUR)</option>
              <option value="USD">$ (USD)</option>
              <option value="GBP">¬£ (GBP)</option>
              <option value="CHF">CHF</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Chiffrement (mot de passe)</label>
            <div class="flex gap-2">
              <input id="passwordInput" type="password" class="input" placeholder="D√©finir/Changer le mot de passe"/>
              <button id="setPasswordBtn" class="btn btn-secondary">Activer</button>
            </div>
            <p class="text-xs text-zinc-500 mt-1">Optionnel : vos donn√©es seront chiffr√©es (AES-GCM, PBKDF2) dans localStorage.</p>
          </div>
          <div class="flex gap-2 pt-2">
            <button id="importJsonBtn" class="btn btn-secondary">üìÇ Importer JSON</button>
            <button id="exportJsonBtn" class="btn btn-secondary">üíæ Exporter JSON</button>
            <button id="resetBtn" class="btn btn-secondary">üóëÔ∏è R√©initialiser</button>
          </div>
        </div>
        <div class="space-y-4">
          <details class="rounded-xl border border-zinc-200 dark:border-zinc-800 p-4">
            <summary class="font-medium cursor-pointer">Connexion bancaire avanc√©e (√† faire plus tard)</summary>
            <ol class="list-decimal pl-6 space-y-1 text-sm mt-2">
              <li>D√©ployer un petit serveur (Cloud Run, Render, OVH) qui g√®re les cl√©s API d'un agr√©gateur (Nordigen/GoCardless, Bridge, Budget Insight).</li>
              <li>Cr√©er un endpoint <code>/link-token</code> et <code>/transactions</code>.</li>
              <li>Dans ce site, renseigner l'URL du proxy ci-dessous puis utiliser le flux de connexion : <input id="proxyUrlInput" class="input mt-2" placeholder="https://votre-proxy.exemple.com"/></li>
              <li>(Optionnel) Contribuer sur GitHub : ce site est <em>static-first</em>, mais extensible.</li>
            </ol>
            <div class="pt-2"><button id="testProxyBtn" class="btn btn-secondary">üîó Tester la connexion</button> <span id="proxyStatus" class="tag">inactif</span></div>
          </details>
          <details class="rounded-xl border border-zinc-200 dark:border-zinc-800 p-4">
            <summary class="font-medium cursor-pointer">Aide import CSV/OFX/QIF</summary>
            <p class="text-sm mt-2">Colonnes reconnues automatiquement : <code>date</code>, <code>description</code>, <code>amount</code>, <code>category</code>, <code>account</code>. Formats de date accept√©s : <code>YYYY-MM-DD</code>, <code>DD/MM/YYYY</code>, <code>MM/DD/YYYY</code>.</p>
          </details>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-zinc-500 pt-6">
      <p>BudgetZen ‚Äî MIT ¬© 2025. Donn√©es locales, aucun tracking. Con√ßu pour GitHub Pages.</p>
    </footer>
  </main>

  <!-- Modals -->
  <dialog id="txDialog" class="rounded-2xl p-0 w-full max-w-xl backdrop:bg-black/40">
    <form method="dialog" class="card">
      <h4 class="text-lg font-semibold mb-3">Transaction</h4>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Date</label>
          <input id="txDate" type="date" class="input" required />
        </div>
        <div>
          <label class="text-sm">Montant</label>
          <input id="txAmount" type="number" step="0.01" class="input" placeholder="-12.90" required />
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm">Libell√©</label>
          <input id="txDesc" class="input" placeholder="Ex: NETFLIX" required />
        </div>
        <div>
          <label class="text-sm">Cat√©gorie</label>
          <input id="txCat" class="input" list="catList" placeholder="Ex: Abonnements" />
          <datalist id="catList"></datalist>
        </div>
        <div>
          <label class="text-sm">Compte</label>
          <input id="txAcc" class="input" placeholder="Ex: Banque Populaire" />
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button class="btn btn-secondary">Annuler</button>
        <button id="txSaveBtn" value="save" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <dialog id="budgetDialog" class="rounded-2xl p-0 w-full max-w-md backdrop:bg-black/40">
    <form method="dialog" class="card">
      <h4 class="text-lg font-semibold mb-3">Budget mensuel</h4>
      <div class="space-y-2">
        <input id="budgetCat" class="input" placeholder="Cat√©gorie (ex: Courses)" />
        <input id="budgetAmount" type="number" step="0.01" class="input" placeholder="Montant mensuel" />
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button class="btn btn-secondary">Annuler</button>
        <button id="budgetSaveBtn" value="save" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <dialog id="ruleDialog" class="rounded-2xl p-0 w-full max-w-md backdrop:bg-black/40">
    <form method="dialog" class="card">
      <h4 class="text-lg font-semibold mb-3">R√®gle d'auto-cat√©gorisation</h4>
      <div class="space-y-2">
        <input id="rulePattern" class="input" placeholder="Mot-cl√© ou /regex/" />
        <input id="ruleCategory" class="input" placeholder="Cat√©gorie" />
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button class="btn btn-secondary">Annuler</button>
        <button id="ruleSaveBtn" value="save" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <dialog id="goalDialog" class="rounded-2xl p-0 w-full max-w-md backdrop:bg-black/40">
    <form method="dialog" class="card">
      <h4 class="text-lg font-semibold mb-3">Objectif</h4>
      <div class="space-y-2">
        <input id="goalName" class="input" placeholder="Ex: √âpargne vacances" />
        <input id="goalTarget" type="number" step="0.01" class="input" placeholder="Montant cible" />
        <input id="goalDue" type="date" class="input" />
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button class="btn btn-secondary">Annuler</button>
        <button id="goalSaveBtn" value="save" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <input id="hiddenJsonImport" type="file" accept="application/json" class="hidden" />

  <script>
  // ----------------------
  // BudgetZen ‚Äî Data layer
  // ----------------------
  const APP_KEY = 'budgetzen_v1';
  const DEFAULT_CATS = ['Abonnements','Logement','Courses','Restaurants','Transport','Sant√©','Loisirs','Voyages','Cadeaux','Imp√¥ts','√âpargne','Salaire','Autre'];
  let state = {
    currency: 'EUR',
    transactions: [], // {id,date,description,amount,category,account,currency}
    budgets: [], // {category, amount}
    rules: [ // quelques r√®gles par d√©faut
      {pattern: 'NETFLIX', category: 'Abonnements'},
      {pattern: 'SPOTIFY', category: 'Abonnements'},
      {pattern: 'AMAZON PRIME', category: 'Abonnements'},
      {pattern: 'UBER', category: 'Transport'},
      {pattern: 'SNCF', category: 'Transport'},
      {pattern: 'CARREFOUR', category: 'Courses'},
    ],
    goals: [], // {name,target,due,saved}
    proxyUrl: '',
    encrypted: false,
  };
  let passwordCache = null; // cl√© d√©riv√©e en m√©moire (non persist√©e)

  // ----------
  // Utilities
  // ----------
  const fmt = (n, cur = state.currency) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: cur }).format(n);
  const by = (k) => (a,b) => a[k] > b[k] ? 1 : a[k] < b[k] ? -1 : 0;
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
  const todayISO = () => new Date().toISOString().slice(0,10);
  const monthKey = (d) => new Date(d).toISOString().slice(0,7); // YYYY-MM
  const norm = (s) => (s||'').toString().toUpperCase().replace(/\s+/g,' ').trim();

  // ----------
  // Encryption (AES-GCM via Web Crypto)
  // ----------
  async function deriveKey(pass) {
    const enc = new TextEncoder();
    const salt = enc.encode('budgetzen_salt_v1');
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations: 120000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    return key;
  }
  async function encryptData(obj) {
    if (!passwordCache) return {encrypted:false, payload: JSON.stringify(obj)};
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = new TextEncoder().encode(JSON.stringify(obj));
    const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, passwordCache, data);
    return {encrypted:true, payload: btoa(String.fromCharCode(...new Uint8Array(iv))) + '.' + btoa(String.fromCharCode(...new Uint8Array(cipher)))};
  }
  async function decryptData(payload) {
    if (!payload) return null;
    try {
      const obj = JSON.parse(payload);
      return obj; // non chiffr√©
    } catch {}
    if (!passwordCache) throw new Error('Mot de passe requis');
    const [ivB64, dataB64] = payload.split('.');
    const iv = Uint8Array.from(atob(ivB64), c=>c.charCodeAt(0));
    const data = Uint8Array.from(atob(dataB64), c=>c.charCodeAt(0));
    const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, passwordCache, data);
    return JSON.parse(new TextDecoder().decode(plain));
  }

  // ----------
  // Persistence
  // ----------
  async function save() {
    const data = { ...state, encrypted: !!passwordCache };
    const {encrypted, payload} = await encryptData(data);
    localStorage.setItem(APP_KEY, JSON.stringify({encrypted, payload}));
  }
  async function load() {
    const raw = localStorage.getItem(APP_KEY);
    if (!raw) return;
    try {
      const obj = JSON.parse(raw);
      if (obj && typeof obj === 'object' && 'payload' in obj) {
        const data = await decryptData(obj.payload);
        Object.assign(state, data);
        state.encrypted = obj.encrypted;
      } else {
        // anciens formats
        Object.assign(state, JSON.parse(raw));
      }
    } catch (e) {
      console.warn('Erreur au chargement:', e);
    }
  }

  // ----------
  // CSV/OFX/QIF Import
  // ----------
  function parseCSV(text) {
    // Supporte ; ou , et quotes basiques
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    if (lines.length === 0) return [];
    const sep = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
    const header = lines[0].split(sep).map(h => h.trim().toLowerCase());
    const idx = {
      date: header.findIndex(h=>/date/.test(h)),
      desc: header.findIndex(h=>/desc|libell|label|name/.test(h)),
      amount: header.findIndex(h=>/amount|montant|value|valeur/.test(h)),
      category: header.findIndex(h=>/categ/.test(h)),
      account: header.findIndex(h=>/account|compte/.test(h)),
      currency: header.findIndex(h=>/curr|devise/.test(h)),
    };
    const out=[];
    for (let i=1;i<lines.length;i++){
      const cols = lines[i].split(sep).map(c=>c.replace(/^"|"$/g,'').trim());
      const d = parseDate(cols[idx.date]);
      const amt = parseFloat(cols[idx.amount]?.replace(',', '.'));
      if (!d || isNaN(amt)) continue;
      out.push({
        id: uid(),
        date: d,
        description: cols[idx.desc] || '',
        amount: amt,
        category: cols[idx.category] || '',
        account: cols[idx.account] || '',
        currency: cols[idx.currency] || state.currency,
      });
    }
    return out;
  }
  function parseDate(s){
    if(!s) return null;
    s = s.trim();
    // ISO
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // DD/MM/YYYY
    const dmy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(dmy){
      const [_,d,m,y]=dmy; const dt=new Date(+y, +m-1, +d); return dt.toISOString().slice(0,10);
    }
    // MM/DD/YYYY
    const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(mdy){
      const [_,m,d,y]=mdy; const dt=new Date(+y, +m-1, +d); return dt.toISOString().slice(0,10);
    }
    // Fallback Date.parse
    const dt = new Date(s); if(!isNaN(dt)) return dt.toISOString().slice(0,10);
    return null;
  }
  function parseOFX(text){
    // ultra simple: chercher <DTPOSTED>, <TRNAMT>, <NAME>
    const tx=[]; const re = /<STMTTRN>[\s\S]*?<DTPOSTED>(.*?)\s*<TRNAMT>(.*?)\s*<NAME>(.*?)\s*<\/STMTTRN>/g;
    let m; while((m=re.exec(text))){
      const dt = m[1].slice(0,8); // YYYYMMDD
      const d = new Date(dt.slice(0,4)+'-'+dt.slice(4,6)+'-'+dt.slice(6,8)).toISOString().slice(0,10);
      tx.push({ id: uid(), date:d, description:m[3], amount: parseFloat(m[2]), category:'', account:'', currency: state.currency });
    }
    return tx;
  }
  function parseQIF(text){
    const lines = text.split(/\r?\n/); const tx=[]; let cur={};
    for(const line of lines){
      const t=line.trim(); if(!t) continue;
      const tag = t[0]; const val=t.slice(1);
      if(tag==='D'){ const d=parseDate(val); cur.date=d; }
      else if(tag==='T'){ cur.amount=parseFloat(val.replace(',','.')); }
      else if(tag==='P'){ cur.description=val; }
      else if(tag==='^'){ if(cur.date && !isNaN(cur.amount)){ tx.push({id:uid(), date:cur.date, description:cur.description||'', amount:cur.amount, category:'', account:'', currency: state.currency}); } cur={}; }
    }
    return tx;
  }

  // ----------
  // Auto-categorization
  // ----------
  function applyRules(tx){
    for(const r of state.rules){
      const isRegex = /^\/.+\/$/.test(r.pattern);
      const test = isRegex ? new RegExp(r.pattern.slice(1,-1),'i') : new RegExp(r.pattern.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');
      if(test.test(tx.description||'')) tx.category = r.category;
    }
  }

  // ----------
  // Subscription detection
  // ----------
  function detectSubscriptions(){
    const map = new Map();
    for(const t of state.transactions){
      if (t.amount >= 0) continue; // d√©penses
      const key = norm(t.description).replace(/\d+/g,'').trim();
      if(!key) continue;
      const arr = map.get(key) || []; arr.push(t); map.set(key, arr);
    }
    const subs=[];
    map.forEach((arr, merchant)=>{
      arr.sort((a,b)=>a.date.localeCompare(b.date));
      if(arr.length < 2) return; // need at least 2 occurrences
      // check quasi mensuel (intervalle entre 28 et 31 jours pour >=2 paires)
      let monthlyHits = 0; let last = null; let sumAbs = 0;
      for(const a of arr){
        sumAbs += Math.abs(a.amount);
        if(last){
          const d1 = new Date(last.date), d2 = new Date(a.date);
          const days = Math.round((d2-d1)/86400000);
          if(days>=27 && days<=33) monthlyHits++;
        }
        last = a;
      }
      if (monthlyHits >= 1) {
        const avg = sumAbs / arr.length;
        subs.push({ merchant, avg, lastDate: arr[arr.length-1].date, freq: 'Mensuel', suggestions: suggestForMerchant(merchant, avg) });
      }
    });
    return subs.sort((a,b)=>b.avg-a.avg);
  }
  function suggestForMerchant(name, avg){
    const n = name.toUpperCase();
    if(n.includes('NETFLIX')||n.includes('SPOTIFY')||n.includes('DISNEY')) return 'V√©rifiez l\'usage et envisagez un partage familial.';
    if(n.includes('ORANGE')||n.includes('SFR')||n.includes('FREE')) return 'Comparez les forfaits : souvent 5‚Äì10‚Ç¨ d\'√©conomie/mois.';
    if(avg>20) return 'N√©gociez ou cherchez une alternative moins ch√®re.';
    return 'OK si utile. R√©-√©valuez tous les 3 mois.';
  }

  // ----------
  // Tips (lightweight heuristics)
  // ----------
  function computeTips(){
    const tips=[];
    const subs = detectSubscriptions();
    const subTotal = subs.reduce((s,x)=>s+x.avg,0);
    if(subTotal>0) tips.push(`Vos abonnements p√®sent ~ ${fmt(subTotal)} / mois. Supprimez-en 1 pour √©conomiser imm√©diatement.`);
    // Cat spend vs budget
    for(const b of state.budgets){
      const spent = monthSpendByCategory(currentMonth(), b.category);
      if(b.amount>0 && spent > b.amount){
        tips.push(`D√©passement du budget ¬´ ${b.category} ¬ª de ${fmt(spent-b.amount)}. Geler la d√©pense sur 7 jours.`);
      }
    }
    const income = monthIncome(currentMonth());
    const expenses = monthExpenses(currentMonth());
    if(income>0){
      const saveRate = Math.max(0, (income - expenses)/income);
      tips.push(`Taux d\'√©pargne estim√©: ${(saveRate*100).toFixed(0)}%. Objectif simple: +5 pts le mois prochain.`);
    }
    tips.push('Astuce: activez les R√®gles pour auto-classer vos op√©rations (gain de temps ‚ú®).');
    if(state.goals.length===0) tips.push('D√©finissez un objectif d\'√©pargne pour rester motiv√©.');
    return tips;
  }

  // ----------
  // Aggregations
  // ----------
  function currentMonth(){ return new Date().toISOString().slice(0,7); }
  function monthIncome(mKey){
    return state.transactions.filter(t=>monthKey(t.date)===mKey && t.amount>0).reduce((s,t)=>s+t.amount,0);
  }
  function monthExpenses(mKey){
    return Math.abs(state.transactions.filter(t=>monthKey(t.date)===mKey && t.amount<0).reduce((s,t)=>s+t.amount,0));
  }
  function monthSpendByCategory(mKey, cat){
    return Math.abs(state.transactions.filter(t=>monthKey(t.date)===mKey && t.amount<0 && (t.category||'')===cat).reduce((s,t)=>s+t.amount,0));
  }

  // ----------
  // Rendering helpers
  // ----------
  function renderKPIs(){
    const m = currentMonth();
    const inc = monthIncome(m);
    const exp = monthExpenses(m);
    document.getElementById('kpiIn').textContent = fmt(inc);
    document.getElementById('kpiOut').textContent = fmt(exp);
    document.getElementById('kpiNet').textContent = fmt(inc - exp);
    document.getElementById('kpiSubs').textContent = detectSubscriptions().length;
  }
  function renderMonthFilter(){
    const select = document.getElementById('monthFilter');
    const months = Array.from(new Set(state.transactions.map(t=>monthKey(t.date)))).sort();
    select.innerHTML = '<option value="">Tous mois</option>' + months.map(m=>`<option value="${m}">${m}</option>`).join('');
  }
  function renderTxTable(){
    const tbody = document.getElementById('txTbody');
    const q = norm(document.getElementById('searchInput').value);
    const m = document.getElementById('monthFilter').value;
    const rows = state.transactions
      .slice().sort((a,b)=>b.date.localeCompare(a.date))
      .filter(t=>!m || monthKey(t.date)===m)
      .filter(t=> !q || norm(t.description).includes(q) || norm(t.category||'').includes(q) );
    tbody.innerHTML = rows.map(t=>`
      <tr class="border-t border-zinc-200 dark:border-zinc-800">
        <td class="whitespace-nowrap">${t.date}</td>
        <td>${escapeHtml(t.description||'')}</td>
        <td class="text-right ${t.amount<0?'text-red-600 dark:text-red-400':'text-emerald-600 dark:text-emerald-400'}">${fmt(t.amount)}</td>
        <td>${escapeHtml(t.category||'')}</td>
        <td>${escapeHtml(t.account||'')}</td>
        <td class="text-right whitespace-nowrap">
          <button class="tag hover:opacity-80" onclick="editTx('${t.id}')">√©diter</button>
          <button class="tag hover:opacity-80" onclick="deleteTx('${t.id}')">suppr.</button>
        </td>
      </tr>
    `).join('');
  }
  function renderBudgets(){
    const wrap = document.getElementById('budgetsList');
    wrap.innerHTML = state.budgets.map(b=>{
      const spent = monthSpendByCategory(currentMonth(), b.category);
      const pct = b.amount>0? Math.min(100, Math.round((spent/b.amount)*100)) : 0;
      return `
      <div class="p-4 rounded-2xl border border-zinc-200 dark:border-zinc-800">
        <div class="flex items-center justify-between mb-2">
          <div class="font-medium">${escapeHtml(b.category)}</div>
          <div class="text-sm text-zinc-500">${fmt(spent)} / ${fmt(b.amount)}</div>
        </div>
        <div class="h-3 bg-zinc-200 dark:bg-zinc-800 rounded-full overflow-hidden">
          <div class="h-3 ${pct<80?'bg-emerald-500':pct<100?'bg-amber-500':'bg-red-600'}" style="width:${pct}%"></div>
        </div>
      </div>`;
    }).join('') || '<p class="text-sm text-zinc-500">Aucun budget. Ajoutez-en pour suivre vos plafonds mensuels.</p>';
  }
  function renderRules(){
    const tbody = document.getElementById('rulesTbody');
    tbody.innerHTML = state.rules.map((r,i)=>`
      <tr class="border-t border-zinc-200 dark:border-zinc-800">
        <td>${escapeHtml(r.pattern)}</td>
        <td>${escapeHtml(r.category)}</td>
        <td class="text-right"><button class="tag hover:opacity-80" onclick="deleteRule(${i})">suppr.</button></td>
      </tr>
    `).join('');
  }
  function renderGoals(){
    const wrap = document.getElementById('goalsList');
    wrap.innerHTML = state.goals.map((g,i)=>{
      const saved = Math.max(0, (monthIncome(currentMonth()) - monthExpenses(currentMonth())) * 0.2 ); // suggestion: 20% r√®gle 50/30/20
      const pct = g.target>0 ? Math.min(100, Math.round((saved/g.target)*100)) : 0;
      return `
        <div class="p-4 rounded-2xl border border-zinc-200 dark:border-zinc-800">
          <div class="flex items-center justify-between mb-2">
            <div class="font-medium">${escapeHtml(g.name)}</div>
            <div class="text-sm text-zinc-500">Objectif: ${fmt(g.target)} ‚Ä¢ √âch√©ance: ${g.due||'‚Äî'}</div>
          </div>
          <div class="h-3 bg-zinc-200 dark:bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-3 ${pct<80?'bg-indigo-500':pct<100?'bg-amber-500':'bg-emerald-600'}" style="width:${pct}%"></div>
          </div>
          <div class="text-xs text-zinc-500 mt-1">Suggestion d\'√©pargne ce mois: ${fmt(saved)} (20% du solde net positif)</div>
          <div class="mt-2 text-right"><button class="tag" onclick="deleteGoal(${i})">suppr.</button></div>
        </div>
      `;
    }).join('') || '<p class="text-sm text-zinc-500">Aucun objectif d√©fini.</p>';
  }
  function renderSubs(){
    const tbody = document.getElementById('subsTbody');
    const subs = detectSubscriptions();
    tbody.innerHTML = subs.map((s,i)=>`
      <tr class="border-t border-zinc-200 dark:border-zinc-800">
        <td>${escapeHtml(s.merchant)}</td>
        <td class="text-right">${fmt(-Math.abs(s.avg))}</td>
        <td>${s.lastDate}</td>
        <td>${s.freq}</td>
        <td class="text-sm text-zinc-500">${escapeHtml(s.suggestions)}</td>
        <td class="text-right"><button class="tag" onclick="cancelSuggestion('${s.merchant}')">options</button></td>
      </tr>
    `).join('') || '<tr><td colspan="6" class="text-sm text-zinc-500">Aucun abonnement r√©current d√©tect√©.</td></tr>';
  }
  function renderTips(){
    const ul = document.getElementById('tipsList');
    const tips = computeTips();
    ul.innerHTML = tips.map(t=>`<li class="p-3 rounded-xl bg-zinc-100 dark:bg-zinc-800">${escapeHtml(t)}</li>`).join('') || '<li class="text-sm text-zinc-500">Importez des op√©rations pour obtenir des conseils personnalis√©s.</li>';
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }

  // ----------
  // Chart
  // ----------
  let cashChart=null;
  function renderChart(){
    const ctx = document.getElementById('cashflowChart');
    const months = getLastNMonths(12);
    const income = months.map(m=>monthIncome(m));
    const expenses = months.map(m=>monthExpenses(m));
    const net = months.map((_,i)=>income[i]-expenses[i]);
    if(cashChart) cashChart.destroy();
    cashChart = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets: [
        { label: 'Revenus', data: income, tension: .25 },
        { label: 'D√©penses', data: expenses, tension: .25 },
        { label: 'Net', data: net, tension: .25 }
      ] },
      options: { responsive: true, plugins: { legend:{position:'bottom'} }, scales:{ y:{ ticks:{ callback:(v)=>fmt(v) } } } }
    });
  }
  function getLastNMonths(n){
    const out=[]; const d=new Date();
    for(let i=n-1;i>=0;i--){ const dt=new Date(d.getFullYear(), d.getMonth()-i, 1); out.push(dt.toISOString().slice(0,7)); }
    return out;
  }

  // ----------
  // Actions
  // ----------
  async function init(){
    await load();
    document.getElementById('currencySelect').value = state.currency;
    if(state.encrypted) document.getElementById('passwordInput').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (activ√©)';
    refreshAll();
  }

  function refreshAll(){
    renderKPIs();
    renderTxTable();
    renderMonthFilter();
    renderBudgets();
    renderRules();
    renderGoals();
    renderSubs();
    renderTips();
    renderChart();
    // update datalist categories
    document.getElementById('catList').innerHTML = Array.from(new Set([...DEFAULT_CATS, ...state.budgets.map(b=>b.category), ...state.transactions.map(t=>t.category)]))
      .filter(Boolean).sort().map(c=>`<option value="${escapeHtml(c)}"></option>`).join('');
  }

  // Exposed for inline handlers
  window.editTx = (id)=>{
    const t = state.transactions.find(x=>x.id===id); if(!t) return;
    const d = document.getElementById('txDialog');
    d.showModal();
    document.getElementById('txDate').value = t.date;
    document.getElementById('txAmount').value = t.amount;
    document.getElementById('txDesc').value = t.description;
    document.getElementById('txCat').value = t.category||'';
    document.getElementById('txAcc').value = t.account||'';
    document.getElementById('txSaveBtn').onclick = async (e)=>{
      e.preventDefault();
      Object.assign(t, {
        date: document.getElementById('txDate').value,
        amount: parseFloat(document.getElementById('txAmount').value),
        description: document.getElementById('txDesc').value,
        category: document.getElementById('txCat').value,
        account: document.getElementById('txAcc').value,
      });
      await save(); refreshAll(); d.close();
    };
  };
  window.deleteTx = async (id)=>{
    state.transactions = state.transactions.filter(t=>t.id!==id);
    await save(); refreshAll();
  };
  window.deleteRule = async (i)=>{ state.rules.splice(i,1); await save(); renderRules(); };
  window.deleteGoal = async (i)=>{ state.goals.splice(i,1); await save(); renderGoals(); };
  window.cancelSuggestion = (merchant)=>{
    alert(`Pour ¬´ ${merchant} ¬ª, pensez √† :\n‚Ä¢ v√©rifier l\'usage r√©el\n‚Ä¢ passer √† une formule annuelle\n‚Ä¢ partager un abonnement familial\n‚Ä¢ ou r√©silier si peu utilis√©.`);
  };

  // Event listeners
  document.getElementById('darkToggle').onclick = ()=>{
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('budgetzen_theme', document.documentElement.classList.contains('dark')?'dark':'light');
  };
  // Theme init
  if(localStorage.getItem('budgetzen_theme')==='dark' || (matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('budgetzen_theme'))){
    document.documentElement.classList.add('dark');
  }

  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    let tx=[];
    if(file.name.toLowerCase().endsWith('.csv') || file.type.includes('csv')) tx = parseCSV(text);
    else if(file.name.toLowerCase().endsWith('.ofx')) tx = parseOFX(text);
    else if(file.name.toLowerCase().endsWith('.qif')) tx = parseQIF(text);
    else tx = parseCSV(text); // tentative
    for(const t of tx){ applyRules(t); }
    state.transactions.push(...tx);
    await save(); refreshAll();
    e.target.value = '';
  });

  document.getElementById('templateBtn').onclick = ()=>{
    const csv = 'date,description,amount,category,account\n2025-08-01,SALAIRE,+2500,Salaire,Banque A\n2025-08-03,CARREFOUR,-82.35,Courses,Banque A\n2025-08-05,NETFLIX,-13.49,Abonnements,Carte X\n';
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'budgetzen_modele.csv'});
    a.click(); URL.revokeObjectURL(url);
  };

  document.getElementById('demoBtn').onclick = async ()=>{
    // generate ~60 demo tx over recent months
    const cats = ['Abonnements','Courses','Restaurants','Transport','Sant√©','Loisirs','Voyages','Salaire'];
    const merchants = {
      Abonnements:['NETFLIX','SPOTIFY','AMAZON PRIME'],
      Courses:['CARREFOUR','LIDL','AUCHAN'],
      Restaurants:['MCDONALD\'S','PIZZERIA ROMA','SUSHIYA'],
      Transport:['SNCF','UBER','TOTAL'],
      Sant√©:['PHARMACIE','DOCTOLIB'],
      Loisirs:['DECATHLON','FNAC'],
      Voyages:['AIR FRANCE','BOOKING'],
      Salaire:['SALAIRE'],
    };
    const now = new Date();
    for(let m=5;m>=0;m--){
      const base = new Date(now.getFullYear(), now.getMonth()-m, 5);
      // salaire
      state.transactions.push({id:uid(), date: new Date(base.getFullYear(), base.getMonth(), 1).toISOString().slice(0,10), description:'SALAIRE', amount: 2500, category:'Salaire', account:'D√©mo', currency: state.currency});
      // abonnements
      state.transactions.push({id:uid(), date: new Date(base.getFullYear(), base.getMonth(), 5).toISOString().slice(0,10), description:'NETFLIX', amount:-13.49, category:'Abonnements', account:'D√©mo', currency: state.currency});
      state.transactions.push({id:uid(), date: new Date(base.getFullYear(), base.getMonth(), 6).toISOString().slice(0,10), description:'SPOTIFY', amount:-9.99, category:'Abonnements', account:'D√©mo', currency: state.currency});
      // d√©penses diverses
      for(let i=0;i<12;i++){
        const cat = cats[Math.floor(Math.random()*cats.length)];
        if(cat==='Salaire') continue;
        const merch = merchants[cat][Math.floor(Math.random()*merchants[cat].length)];
        const day = 7 + Math.floor(Math.random()*21);
        const amt = - (5 + Math.random()*120);
        state.transactions.push({id:uid(), date: new Date(base.getFullYear(), base.getMonth(), day).toISOString().slice(0,10), description: merch, amount: parseFloat(amt.toFixed(2)), category:cat, account:'D√©mo', currency: state.currency});
      }
    }
    await save(); refreshAll();
  };

  document.getElementById('addTxBtn').onclick = ()=>{
    const d = document.getElementById('txDialog');
    document.getElementById('txDate').value = todayISO();
    document.getElementById('txAmount').value = '';
    document.getElementById('txDesc').value = '';
    document.getElementById('txCat').value = '';
    document.getElementById('txAcc').value = '';
    d.showModal();
    document.getElementById('txSaveBtn').onclick = async (e)=>{
      e.preventDefault();
      const t = {
        id: uid(),
        date: document.getElementById('txDate').value,
        amount: parseFloat(document.getElementById('txAmount').value),
        description: document.getElementById('txDesc').value,
        category: document.getElementById('txCat').value,
        account: document.getElementById('txAcc').value,
        currency: state.currency,
      };
      applyRules(t);
      state.transactions.push(t);
      await save(); refreshAll(); d.close();
    };
  };

  document.getElementById('addBudgetBtn').onclick = ()=>{
    const d = document.getElementById('budgetDialog'); d.showModal();
    document.getElementById('budgetCat').value = '';
    document.getElementById('budgetAmount').value = '';
    document.getElementById('budgetSaveBtn').onclick = async (e)=>{
      e.preventDefault();
      const b = { category: document.getElementById('budgetCat').value, amount: parseFloat(document.getElementById('budgetAmount').value) };
      const idx = state.budgets.findIndex(x=>x.category===b.category);
      if(idx>=0) state.budgets[idx]=b; else state.budgets.push(b);
      await save(); renderBudgets(); d.close();
    };
  };

  document.getElementById('addRuleBtn').onclick = ()=>{
    const d = document.getElementById('ruleDialog'); d.showModal();
    document.getElementById('rulePattern').value='';
    document.getElementById('ruleCategory').value='';
    document.getElementById('ruleSaveBtn').onclick = async (e)=>{
      e.preventDefault();
      state.rules.push({ pattern: document.getElementById('rulePattern').value, category: document.getElementById('ruleCategory').value });
      await save(); renderRules(); d.close();
    };
  };

  document.getElementById('addGoalBtn').onclick = ()=>{
    const d = document.getElementById('goalDialog'); d.showModal();
    document.getElementById('goalName').value='';
    document.getElementById('goalTarget').value='';
    document.getElementById('goalDue').value='';
    document.getElementById('goalSaveBtn').onclick = async (e)=>{
      e.preventDefault();
      state.goals.push({ name: document.getElementById('goalName').value, target: parseFloat(document.getElementById('goalTarget').value||'0'), due: document.getElementById('goalDue').value||'' });
      await save(); renderGoals(); d.close();
    };
  };

  document.getElementById('refreshSubsBtn').onclick = ()=>{ renderSubs(); renderTips(); };
  document.getElementById('searchInput').oninput = renderTxTable;
  document.getElementById('monthFilter').onchange = renderTxTable;

  document.getElementById('currencySelect').onchange = async (e)=>{ state.currency = e.target.value; await save(); refreshAll(); };
  document.getElementById('setPasswordBtn').onclick = async ()=>{
    const pass = document.getElementById('passwordInput').value;
    if(!pass){ passwordCache=null; state.encrypted=false; await save(); alert('Chiffrement d√©sactiv√©.'); return; }
    passwordCache = await deriveKey(pass); state.encrypted=true; await save(); alert('Chiffrement activ√©. Sauvegarde chiffr√©e.');
  };

  document.getElementById('exportBtn').onclick = ()=>{
    const csv = toCSV(state.transactions);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'budgetzen_transactions.csv'});
    a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById('exportJsonBtn').onclick = async ()=>{
    const payload = await encryptData(state); // si mdp actif, r√©utilise AES
    const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'budgetzen_data.json'});
    a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById('importJsonBtn').onclick = ()=> document.getElementById('hiddenJsonImport').click();
  document.getElementById('hiddenJsonImport').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; const text=await f.text();
    try{
      const obj=JSON.parse(text);
      if(obj && typeof obj==='object' && 'payload' in obj){
        // payload chiffr√©
        const data = await decryptData(obj.payload);
        Object.assign(state, data);
      } else {
        Object.assign(state, obj);
      }
      await save(); refreshAll();
    }catch(err){ alert('Import JSON invalide'); }
  });
  document.getElementById('resetBtn').onclick = ()=>{
    if(confirm('Supprimer toutes les donn√©es locales ?')){ localStorage.removeItem(APP_KEY); location.reload(); }
  };

  document.getElementById('testProxyBtn').onclick = async ()=>{
    const url = document.getElementById('proxyUrlInput').value.trim(); if(!url){ alert('Renseignez l\'URL du proxy.'); return; }
    state.proxyUrl = url; await save();
    // simple HEAD/GET ping (CORS peut bloquer ‚Äî on se contente d\'essayer)
    try{ const r = await fetch(url, {method:'GET', mode:'no-cors'}); document.getElementById('proxyStatus').textContent='ok (non v√©rifi√©)'; }
    catch{ document.getElementById('proxyStatus').textContent='erreur'; }
  };

  function toCSV(arr){
    const header = 'date,description,amount,category,account\n';
    const body = arr.map(t=>[t.date, escapeCsv(t.description), t.amount, escapeCsv(t.category||''), escapeCsv(t.account||'')].join(',')).join('\n');
    return header+body;
  }
  function escapeCsv(s){ return '"'+String(s).replace(/"/g,'""')+'"'; }

  // Init
  init();
  </script>
</body>
</html>
